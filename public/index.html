<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIOCUBE | Core Interface</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --acid-green: #bfff00;
            --cyber-blue: #00f2ff;
            --warning-orange: #ff9d00;
            --danger-red: #ff3c3c;
            --deep-space: #05070a;
            --panel-bg: rgba(16, 20, 25, 0.9);
            --accent-glow: rgba(191, 255, 0, 0.15);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--deep-space);
            color: #e0e0e0;
            margin: 0;
            background-image: 
                linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .app-container { max-width: 1400px; margin: 0 auto; padding: 20px 15px 100px 15px; }

        /* --- TOOLTIP SYSTEM --- */
        .help-icon {
            display: inline-block;
            width: 16px; height: 16px;
            background: var(--cyber-blue);
            color: #000; border-radius: 50%;
            text-align: center; font-size: 11px;
            line-height: 16px; cursor: help;
            font-weight: bold; margin-left: 8px;
            vertical-align: middle;
        }

        .help-icon:hover::after {
            content: attr(data-info);
            position: absolute; left: 10px; right: 10px; top: 40px;
            background: #111; color: #fff; border: 1px solid var(--cyber-blue);
            padding: 10px; border-radius: 5px; z-index: 100; font-family: 'Rajdhani';
            font-weight: normal; text-transform: none; line-height: 1.3;
        }

        /* --- AUTH --- */
        #auth-screen { height: 100vh; display: flex; align-items: center; justify-content: center; background: #000; }
        .terminal-card { background: var(--panel-bg); border: 1px solid var(--acid-green); padding: 30px; width: 350px; text-align: center; }
        input { background: #000; border: 1px solid #333; padding: 12px; color: var(--cyber-blue); font-family: 'Rajdhani'; margin-bottom: 10px; width: 100%; box-sizing: border-box; }

        /* --- NAV --- */
        nav { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #222; z-index: 1000; }
        nav button { background: none; border: none; color: #555; font-family: 'Orbitron'; font-size: 0.65rem; cursor: pointer; }
        nav button.active { color: var(--acid-green); }

        /* --- CARDS --- */
        .hud-card { background: var(--panel-bg); border-left: 3px solid var(--cyber-blue); padding: 15px; margin-bottom: 15px; position: relative; border-radius: 0 5px 5px 0; }
        .hud-header { font-family: 'Orbitron'; font-size: 0.75rem; color: var(--cyber-blue); margin-bottom: 12px; display: flex; align-items: center; }
        
        /* --- SENSOR GRID --- */
        .sensor-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .sensor-module { background: rgba(255,255,255,0.02); padding: 15px; text-align: center; border: 1px solid #222; }
        .sensor-module .val { font-size: 1.8rem; font-weight: bold; color: #fff; }
        .sensor-module label { font-size: 0.65rem; color: var(--cyber-blue); text-transform: uppercase; display: block; }

        /* --- NPK SPECIFIC --- */
        .npk-inputs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 5px; }
        .npk-box { background: #000; padding: 10px; border: 1px solid #333; }
        .npk-box label { color: var(--warning-orange); font-size: 0.7rem; display: block; }
        .npk-box input { margin: 5px 0 0 0; padding: 5px; font-size: 1rem; text-align: center; }

        /* --- ADMIN TABLE --- */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th { text-align: left; color: var(--acid-green); padding: 8px; font-family: 'Orbitron'; font-size: 0.6rem; }
        td { padding: 12px 8px; border-bottom: 1px solid #222; }
        .btn-mini { padding: 4px 8px; cursor: pointer; font-family: 'Rajdhani'; font-weight: bold; border: none; border-radius: 3px; }
        .btn-promote { background: var(--acid-green); color: #000; }
        .btn-demote { background: var(--warning-orange); color: #000; }
        .btn-delete { background: var(--danger-red); color: #fff; }

        .btn-master { width: 100%; padding: 15px; font-family: 'Orbitron'; font-weight: bold; border: none; cursor: pointer; margin-bottom: 10px; }
        .btn-master.on { background: var(--acid-green); color: #000; }
        .btn-master.off { background: #222; color: #fff; }
        
        .control-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #222; }
        .btn-toggle { padding: 6px 15px; border-radius: 15px; border: 1px solid #444; background: none; color: #fff; cursor: pointer; }
        .btn-toggle.active { background: var(--cyber-blue); color: #000; }

        .hidden { display: none !important; }
        .disabled { opacity: 0.2; pointer-events: none; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="terminal-card">
            <h1 style="font-family:'Orbitron'; color:var(--acid-green)">BIOCUBE</h1>
            <input type="text" id="username" placeholder="OPERATOR_ID">
            <input type="password" id="password" placeholder="ACCESS_CODE">
            <button class="btn-master on" onclick="auth('login')">INITIALIZE SYSTEM</button>
            <p id="auth-msg"></p>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <nav>
            <button class="active" onclick="nav('home', this)">STATUS</button>
            <button onclick="nav('auto', this)">LOGIC</button>
            <button onclick="nav('manual', this)">CORE</button>
            <button id="btn-admin-nav" class="hidden" onclick="nav('admin', this)">ADMIN</button>
            <button onclick="logout()" style="color:var(--danger-red)">EXIT</button>
        </nav>

        <div class="app-container">
            
            <div id="page-home">
                <div class="hud-card">
                    <div class="hud-header">
                        LIVE_FEED <span class="help-icon" data-info="Real-time visual monitoring. Double-tap the stream to toggle full-screen focus.">?</span>
                    </div>
                    <div style="background:#000; aspect-ratio:16/9; overflow:hidden; border-radius:5px;">
                        <img id="cam-feed" src="" alt="WAITING FOR PACKETS..." style="width:100%">
                    </div>
                </div>

                <div class="sensor-grid">
                    <div class="sensor-module"><label>Temp</label><div class="val" id="val-temp">--</div></div>
                    <div class="sensor-module"><label>Humid</label><div class="val" id="val-hum">--</div></div>
                    <div class="sensor-module"><label>Soil</label><div class="val" id="val-soil">--</div></div>
                    <div class="sensor-module"><label>NPK Raw</label><div class="val" id="val-npk" style="font-size:1.2rem">--</div></div>
                </div>
            </div>

            <div id="page-auto" class="hidden">
                <div class="hud-card">
                    <div class="hud-header">AUTOMATION_EEPROM <span class="help-icon" data-info="Set environment limits. If sensors cross these values, the cube will auto-correct using attached hardware.">?</span></div>
                    <button id="btn-auto-master" class="btn-master on" onclick="toggleAuto()">AUTO-MODE: ACTIVE</button>
                    
                    <div class="control-row"><span>Max Temperature (°C)</span><input type="number" id="th-temp" style="width:60px" value="28"></div>
                    <div class="control-row"><span>Min Soil Moisture (%)</span><input type="number" id="th-soil" style="width:60px" value="30"></div>
                    
                    <div style="margin-top:20px;">
                        <span style="font-size:0.8rem; color:var(--cyber-blue); font-family:'Orbitron'">NPK THRESHOLDS (PPM)</span>
                        <div class="npk-inputs">
                            <div class="npk-box"><label>N</label><input type="number" id="th-n" value="50"></div>
                            <div class="npk-box"><label>P</label><input type="number" id="th-p" value="30"></div>
                            <div class="npk-box"><label>K</label><input type="number" id="th-k" value="40"></div>
                        </div>
                    </div>

                    <button class="btn-master on" style="margin-top:20px;" onclick="saveThresholds()">SYNC TO CORE</button>
                </div>
            </div>

            <div id="page-manual" class="hidden">
                <div class="hud-card">
                    <div class="hud-header">HARDWARE_RELAYS <span class="help-icon" data-info="Direct relay control. WARNING: Automation must be DISABLED in the Logic tab to use manual overrides.">?</span></div>
                    <div id="manual-lock-notice" style="color:var(--warning-orange); font-size:0.8rem; margin-bottom:15px;">⚠️ SYSTEM LOCKED: AUTO-MODE ACTIVE</div>
                    <div id="manual-controls" class="disabled">
                        <div class="control-row"><span>Water Pump</span><button class="btn-toggle" onclick="toggleActuator('water', this)">OFF</button></div>
                        <div class="control-row"><span>Nutrient Injector</span><button class="btn-toggle" onclick="toggleActuator('nutrient', this)">OFF</button></div>
                        <div class="control-row"><span>Exhaust Fan</span><button class="btn-toggle" onclick="toggleActuator('exhaust', this)">OFF</button></div>
                        <div class="control-row"><span>Cooling Array</span><button class="btn-toggle" onclick="toggleActuator('cool', this)">OFF</button></div>
                    </div>
                </div>
            </div>

            <div id="page-admin" class="hidden">
                <div class="hud-card">
                    <div class="hud-header">OPERATOR_MANAGEMENT <span class="help-icon" data-info="Root control. Promote users to Admin to grant them access to this tab, or delete inactive IDs.">?</span></div>
                    <table>
                        <thead><tr><th>OPERATOR</th><th>ROLE</th><th>ACTIONS</th></tr></thead>
                        <tbody id="admin-user-list"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        const socket = io();
        let isAuto = true;
        let currentUser = "";

        async function auth(type) {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const res = await fetch(`/api/${type}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            const data = await res.json();
            if(data.status === 'ok') {
                currentUser = u;
                localStorage.setItem('token', data.token);
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                if(data.role === 'admin') document.getElementById('btn-admin-nav').classList.remove('hidden');
            } else { alert("INVALID ACCESS CODE"); }
        }

        function nav(page, btn) {
            document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            btn.classList.add('active');
            if(page === 'admin') loadAdminData();
        }

        socket.on('update', (data) => {
            document.getElementById('val-temp').innerText = data.temp_in.toFixed(1);
            document.getElementById('val-hum').innerText = data.hum_in.toFixed(1);
            document.getElementById('val-soil').innerText = data.soil_moisture;
            document.getElementById('val-npk').innerText = `${data.npk_n}|${data.npk_p}|${data.npk_k}`;
            
            isAuto = data.auto_mode;
            const autoBtn = document.getElementById('btn-auto-master');
            const manualBox = document.getElementById('manual-controls');
            const notice = document.getElementById('manual-lock-notice');

            autoBtn.innerText = isAuto ? "AUTO-MODE: ACTIVE" : "AUTO-MODE: DISABLED";
            autoBtn.className = isAuto ? "btn-master on" : "btn-master off";
            isAuto ? manualBox.classList.add('disabled') : manualBox.classList.remove('disabled');
            isAuto ? notice.classList.remove('hidden') : notice.classList.add('hidden');
        });

        socket.on('feed', (data) => { document.getElementById('cam-feed').src = 'data:image/jpeg;base64,' + data; });

        function toggleAuto() { socket.emit('control_cmd', { cmd: 'set_auto', val: !isAuto }); }

        function saveThresholds() {
            const vals = {
                temp: parseInt(document.getElementById('th-temp').value),
                soil: parseInt(document.getElementById('th-soil').value),
                n: parseInt(document.getElementById('th-n').value),
                p: parseInt(document.getElementById('th-p').value),
                k: parseInt(document.getElementById('th-k').value)
            };
            socket.emit('control_cmd', { cmd: 'update_thresholds', val: vals });
            alert("COMMAND SENT: EEPROM SYNCED");
        }

        function toggleActuator(name, btn) {
            const turnOn = !btn.classList.contains('active');
            socket.emit('control_cmd', { cmd: name, val: turnOn });
            btn.classList.toggle('active');
            btn.innerText = turnOn ? "ON" : "OFF";
        }

        // --- ADMIN LOGIC ---
        async function loadAdminData() {
            const res = await fetch('/api/users');
            const users = await res.json();
            const list = document.getElementById('admin-user-list');
            list.innerHTML = users.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td style="color:${u.role === 'admin' ? 'var(--acid-green)' : '#888'}">${u.role.toUpperCase()}</td>
                    <td>
                        ${u.role === 'operator' ? 
                            `<button class="btn-mini btn-promote" onclick="adminAction('${u.username}', 'promote')">PROMOTE</button>` :
                            `<button class="btn-mini btn-demote" onclick="adminAction('${u.username}', 'demote')">DEMOTE</button>`
                        }
                        <button class="btn-mini btn-delete" onclick="adminAction('${u.username}', 'delete')">DEL</button>
                    </td>
                </tr>
            `).join('');
        }

        async function adminAction(targetUser, action) {
            if(targetUser === currentUser && action !== 'promote') return alert("CANNOT MODIFY SELF");
            await fetch('/api/admin/action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({targetUser, action})
            });
            loadAdminData();
        }

        function logout() { localStorage.removeItem('token'); location.reload(); }
    </script>
</body>
</html>
