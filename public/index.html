<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIOCUBE | Core Interface</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --acid-green: #bfff00;
            --cyber-blue: #00f2ff;
            --warning-orange: #ff9d00;
            --danger-red: #ff3c3c;
            --deep-space: #05070a;
            --panel-bg: rgba(20, 25, 30, 0.95);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--deep-space);
            color: #e0e0e0;
            margin: 0;
            overflow-x: hidden;
            background-image: linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px), 
                              linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* --- AUTH SCREEN --- */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1a202c 0%, #05070a 100%);
            z-index: 10000;
        }
        .terminal-card {
            background: var(--panel-bg); border: 1px solid var(--acid-green);
            padding: 40px; border-radius: 5px; box-shadow: 0 0 20px rgba(191, 255, 0, 0.15);
            width: 90%; max-width: 400px; text-align: center;
        }
        .terminal-card h1 { font-family: 'Orbitron'; color: var(--acid-green); letter-spacing: 5px; margin-bottom: 30px; }

        input {
            width: 100%; box-sizing: border-box; background: rgba(0,0,0,0.5);
            border: 1px solid #333; padding: 15px; color: var(--cyber-blue);
            font-family: 'Rajdhani'; font-size: 1.1rem; margin-bottom: 10px;
            outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--cyber-blue); box-shadow: 0 0 10px rgba(0, 242, 255, 0.2); }

        /* --- NAVIGATION --- */
        nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(5, 7, 10, 0.95); border-top: 1px solid rgba(0, 242, 255, 0.2);
            display: flex; justify-content: space-around; padding: 10px 0;
            z-index: 1000; backdrop-filter: blur(10px);
        }
        @media (min-width: 768px) {
            nav { top: 0; bottom: auto; border-top: none; border-bottom: 1px solid rgba(0, 242, 255, 0.2); }
        }
        nav button {
            background: none; border: none; color: #666; font-family: 'Orbitron';
            font-size: 0.7rem; cursor: pointer; transition: 0.3s; padding: 10px;
        }
        nav button.active { color: var(--acid-green); text-shadow: 0 0 10px var(--acid-green); }

        .app-container { max-width: 1200px; margin: 0 auto; padding: 15px 15px 80px 15px; }
        @media (min-width: 768px) { .app-container { padding-top: 80px; } }

        .hud-card {
            background: var(--panel-bg); border-left: 4px solid var(--cyber-blue);
            padding: 20px; margin-bottom: 15px; border-radius: 0 10px 10px 0;
        }
        .hud-header {
            font-family: 'Orbitron'; font-size: 0.8rem; color: var(--cyber-blue);
            margin-bottom: 15px; display: flex; justify-content: space-between;
        }

        .cam-wrapper { width: 100%; background: #000; border-radius: 8px; overflow: hidden; position: relative; }
        #cam-feed { width: 100%; display: block; transform: rotate(180deg); transition: 0.3s; }
        #cam-feed.fullscreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; object-fit: contain; background: #000; }

        .sensor-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        @media (min-width: 768px) { .sensor-grid { grid-template-columns: repeat(4, 1fr); } }
        .sensor-module { 
            background: rgba(255,255,255,0.03); padding: 15px; text-align: center; 
            border: 1px solid rgba(255,255,255,0.05); transition: 0.3s;
        }
        .sensor-module:hover { border-color: var(--cyber-blue); }
        .sensor-module .val { font-size: 2.2rem; font-weight: 700; color: #fff; line-height: 1; }
        .sensor-module label { font-size: 0.7rem; color: var(--cyber-blue); text-transform: uppercase; display: block; margin-bottom: 5px; }

        .btn-master {
            width: 100%; padding: 15px; font-family: 'Orbitron'; font-weight: bold;
            border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;
            text-transform: uppercase;
        }
        .btn-master.on { background: var(--acid-green); color: #000; box-shadow: 0 0 15px rgba(191, 255, 0, 0.3); }
        .btn-master.off { background: #222; color: #fff; }
        
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #222; }
        .btn-toggle { padding: 8px 15px; border-radius: 20px; border: 1px solid #444; background: none; color: #fff; font-weight: bold; cursor: pointer; }
        .btn-toggle.active { background: var(--cyber-blue); color: #000; border-color: var(--cyber-blue); }

        .hidden { display: none !important; }
        .disabled { opacity: 0.2; pointer-events: none; }
        
        .admin-table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { color: var(--cyber-blue); text-align: left; padding: 12px; border-bottom: 2px solid #222; }
        td { padding: 12px; border-bottom: 1px solid #111; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="terminal-card">
            <h1>BIOCUBE</h1>
            <input type="text" id="username" placeholder="OPERATOR_ID">
            <input type="password" id="password" placeholder="ACCESS_CODE">
            <div style="margin-top: 15px;">
                <button class="btn-master on" onclick="handleAuth('login')">INITIALIZE</button>
                <button class="btn-master off" style="font-size: 0.7rem; margin-top: 8px;" onclick="handleAuth('register')">NEW REGISTRATION</button>
            </div>
            <p id="auth-msg" style="color:var(--danger-red); margin-top:15px; font-size:0.8rem;"></p>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <nav>
            <button class="active" onclick="nav('home', this)">STATUS</button>
            <button onclick="nav('manual', this)">OVERRIDE</button>
            <button onclick="nav('settings', this)">LOGIC</button>
            <button id="btn-admin-nav" class="hidden" onclick="nav('admin', this)">ADMIN</button>
            <button onclick="logout()" style="color:var(--danger-red)">EXIT</button>
        </nav>

        <div class="app-container">
            
            <div id="page-home">
                <div class="hud-card">
                    <div class="hud-header">
                        <span>LIVE_FEED_01</span>
                        <span id="pi-status-tag" style="color:var(--danger-red)">● LINK_DOWN</span>
                    </div>
                    <div class="cam-wrapper">
                        <img id="cam-feed" src="" alt="SIGNAL LOST" ondblclick="toggleFullCam()">
                    </div>
                </div>

                <div class="sensor-grid">
                    <div class="sensor-module"><label>Temp</label><div class="val" id="v-temp">--</div><span>°C</span></div>
                    <div class="sensor-module"><label>Humid</label><div class="val" id="v-hum">--</div><span>%</span></div>
                    <div class="sensor-module"><label>Soil</label><div class="val" id="v-soil">--</div><span>%</span></div>
                    <div class="sensor-module"><label>NPK (N-P-K)</label><div class="val" id="v-npk" style="font-size:1.1rem">--</div></div>
                </div>

                <div class="hud-card" style="margin-top:20px;">
                    <div class="hud-header">24H_DATA_TREND</div>
                    <canvas id="sensorChart" style="max-height: 250px;"></canvas>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-master off" style="margin-top:15px; font-size:0.7rem;" onclick="window.open('/api/download/standard')">CSV LOGS</button>
                        <button class="btn-master off" style="margin-top:15px; font-size:0.7rem;" onclick="window.open('/api/download/academic')">RAW JSON</button>
                    </div>
                </div>
            </div>

            <div id="page-manual" class="hidden">
                <div class="hud-card">
                    <div class="hud-header">HARDWARE_OVERRIDE</div>
                    <p id="manual-lock-msg" style="color:var(--warning-orange); font-size:0.8rem;">⚠️ AUTO-MODE ACTIVE: COMMANDS REJECTED</p>
                    <div id="manual-controls" class="disabled">
                        <div class="toggle-row"><span>Water Pump</span><button class="btn-toggle" onclick="toggleActuator('water', this)">OFF</button></div>
                        <div class="toggle-row"><span>Nutrient Pump</span><button class="btn-toggle" onclick="toggleActuator('nutrient', this)">OFF</button></div>
                        <div class="toggle-row"><span>Exhaust Fan</span><button class="btn-toggle" onclick="toggleActuator('exhaust', this)">OFF</button></div>
                        <div class="toggle-row"><span>Peltier Cooling</span><button class="btn-toggle" onclick="toggleActuator('cool', this)">OFF</button></div>
                    </div>
                </div>
            </div>

            <div id="page-settings" class="hidden">
                <div class="hud-card">
                    <div class="hud-header">SYSTEM_THRESHOLDS</div>
                    <div class="toggle-row" style="margin-bottom:20px;">
                        <span>AUTO MODE</span>
                        <button id="btn-auto-toggle" class="btn-toggle" onclick="toggleAuto()">OFF</button>
                    </div>
                    
                    <div class="input-group">
                        <div class="toggle-row">
                            <span>Cooling Trigger (Temp > X°C)</span>
                            <input type="number" id="th-temp" value="28" style="width:60px;">
                        </div>
                        <div class="toggle-row">
                            <span>Exhaust Trigger (Humid > X%)</span>
                            <input type="number" id="th-hum" value="70" style="width:60px;">
                        </div>
                        <div class="toggle-row">
                            <span>Watering Trigger (Soil < X%)</span>
                            <input type="number" id="th-soil" value="30" style="width:60px;">
                        </div>
                        <button class="btn-master on" onclick="updateThresholds()">SYNC TO BIOCUBE</button>
                    </div>
                </div>
            </div>

            <div id="page-admin" class="hidden">
                <div class="hud-card">
                    <div class="hud-header">OPERATOR_MANAGEMENT</div>
                    <div class="admin-table-container">
                        <table>
                            <thead>
                                <tr><th>USER</th><th>ROLE</th><th>PERMS</th><th>ACTION</th></tr>
                            </thead>
                            <tbody id="admin-user-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const socket = io();
        let isAuto = true;
        let myRole = 'operator';

        // --- AUTHENTICATION ---
        async function handleAuth(type) {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(!u || !p) return alert("Credentials Required");

            const res = await fetch(`/api/${type}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            const data = await res.json();
            
            if(data.status === 'ok') {
                if(type === 'login') {
                    localStorage.setItem('token', data.token);
                    myRole = data.role;
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app-screen').classList.remove('hidden');
                    if(myRole === 'admin') document.getElementById('btn-admin-nav').classList.remove('hidden');
                } else {
                    alert("Registration Successful. Please Initialize.");
                }
            } else {
                document.getElementById('auth-msg').innerText = data.error.toUpperCase();
            }
        }

        function logout() { localStorage.removeItem('token'); location.reload(); }

        // --- NAVIGATION ---
        function nav(page, btn) {
            document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            btn.classList.add('active');
            if(page === 'admin') loadAdminData();
        }

        // --- SOCKETS ---
        socket.on('feed', (data) => { document.getElementById('cam-feed').src = 'data:image/jpeg;base64,' + data; });
        
        socket.on('pi_status', (data) => {
            const tag = document.getElementById('pi-status-tag');
            if(data.online) {
                tag.innerText = "● LINK_ACTIVE"; tag.style.color = "var(--acid-green)";
            } else {
                tag.innerText = "● LINK_DOWN"; tag.style.color = "var(--danger-red)";
            }
        });

        socket.on('update', (data) => {
            document.getElementById('v-temp').innerText = data.temp_in ? data.temp_in.toFixed(1) : "--";
            document.getElementById('v-hum').innerText = data.hum_in ? data.hum_in.toFixed(1) : "--";
            document.getElementById('v-soil').innerText = data.soil_moisture || "--";
            document.getElementById('v-npk').innerText = `${data.npk_n || 0}-${data.npk_p || 0}-${data.npk_k || 0}`;
            
            isAuto = data.auto_mode;
            const autoBtn = document.getElementById('btn-auto-toggle');
            const manualDiv = document.getElementById('manual-controls');
            const lockMsg = document.getElementById('manual-lock-msg');

            autoBtn.innerText = isAuto ? "ON" : "OFF";
            autoBtn.className = isAuto ? "btn-toggle active" : "btn-toggle";
            
            if(isAuto) { manualDiv.classList.add('disabled'); lockMsg.classList.remove('hidden'); }
            else { manualDiv.classList.remove('disabled'); lockMsg.classList.add('hidden'); }
            
            updateChart(data);
        });

        // --- CONTROLS & THRESHOLDS ---
        function toggleFullCam() { document.getElementById('cam-feed').classList.toggle('fullscreen'); }
        function toggleAuto() { socket.emit('control_cmd', { cmd: 'set_auto', val: !isAuto }); }
        
        function toggleActuator(name, btn) {
            const turnOn = btn.innerText === "OFF";
            socket.emit('control_cmd', { cmd: name, val: turnOn });
            btn.innerText = turnOn ? "ON" : "OFF";
            btn.classList.toggle('active');
        }

        function updateThresholds() {
            const t = parseInt(document.getElementById('th-temp').value);
            const h = parseInt(document.getElementById('th-hum').value); // EXHAUST THRESHOLD
            const s = parseInt(document.getElementById('th-soil').value);
            
            if(isNaN(t) || isNaN(h) || isNaN(s)) return alert("INVALID DATA");
            
            socket.emit('control_cmd', { 
                cmd: 'update_thresholds', 
                val: { temp: t, humid: h, soil: s } 
            });
            alert("THRESHOLDS SYNCED TO CORE");
        }

        // --- ADMIN MANAGEMENT ---
        async function loadAdminData() {
            const res = await fetch('/api/users');
            const users = await res.json();
            const tbody = document.getElementById('admin-user-list');
            tbody.innerHTML = '';
            users.forEach(u => {
                tbody.innerHTML += `<tr>
                    <td>${u.username}</td>
                    <td>${u.role}</td>
                    <td>M:${u.canManual ? 'Y' : 'N'} | A:${u.canEditAuto ? 'Y' : 'N'}</td>
                    <td>
                        <button onclick="adminAction('${u.username}', 'ban')" style="color:red; background:none; border:none; cursor:pointer;">BAN</button>
                        <button onclick="adminAction('${u.username}', 'promote')" style="color:cyan; background:none; border:none; cursor:pointer;">PRO</button>
                        <button onclick="adminAction('${u.username}', 'delete')" style="color:gray; background:none; border:none; cursor:pointer;">DEL</button>
                    </td>
                </tr>`;
            });
        }

        async function adminAction(targetUser, action) {
            if(!confirm(`Confirm ${action} on ${targetUser}?`)) return;
            await fetch('/api/admin/action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({targetUser, action})
            });
            loadAdminData();
        }

        // --- CHARTING ---
        const ctx = document.getElementById('sensorChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Temp', data: [], borderColor: '#00f2ff', tension: 0.4, pointRadius: 0 },
                    { label: 'Soil', data: [], borderColor: '#bfff00', tension: 0.4, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { 
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } }, 
                    x: { grid: { display: false }, ticks: { display: false } } 
                },
                plugins: { legend: { labels: { color: '#fff', font: { family: 'Rajdhani' } } } }
            }
        });

        function updateChart(data) {
            const time = new Date().toLocaleTimeString();
            if(chart.data.labels.length > 30) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
                chart.data.datasets[1].data.shift();
            }
            chart.data.labels.push(time);
            chart.data.datasets[0].data.push(data.temp_in);
            chart.data.datasets[1].data.push(data.soil_moisture);
            chart.update();
        }
    </script>
</body>
</html>
