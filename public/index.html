<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIOCUBE | Core Interface</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --acid-green: #bfff00;
            --cyber-blue: #00f2ff;
            --warning-orange: #ff9d00;
            --danger-red: #ff3c3c;
            --deep-space: #05070a;
            --panel-bg: rgba(20, 25, 30, 0.95);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--deep-space);
            color: #e0e0e0;
            margin: 0;
            overflow-x: hidden;
            background-image: linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px), 
                              linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* --- AUTH SCREEN --- */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1a202c 0%, #05070a 100%);
            z-index: 10000;
        }
        .terminal-card {
            background: var(--panel-bg); border: 1px solid var(--acid-green);
            padding: 40px; border-radius: 5px; box-shadow: 0 0 20px rgba(191, 255, 0, 0.15);
            width: 90%; max-width: 400px; text-align: center;
        }
        .terminal-card h1 { font-family: 'Orbitron'; color: var(--acid-green); letter-spacing: 5px; margin-bottom: 30px; }

        input, select {
            width: 100%; box-sizing: border-box; background: rgba(0,0,0,0.5);
            border: 1px solid #333; padding: 15px; color: var(--cyber-blue);
            font-family: 'Rajdhani'; font-size: 1.1rem; margin-bottom: 10px;
            outline: none; transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--cyber-blue); box-shadow: 0 0 10px rgba(0, 242, 255, 0.2); }
        
        /* Custom Select Styling */
        select { appearance: none; cursor: pointer; }
        option { background: #111; color: var(--cyber-blue); }

        /* --- CUSTOM SLIDER --- */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent; padding: 0; margin: 10px 0;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: var(--acid-green); cursor: pointer; margin-top: -6px;
            box-shadow: 0 0 10px var(--acid-green);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #333; border-radius: 2px;
        }

        /* --- NAVIGATION --- */
        nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(5, 7, 10, 0.95); border-top: 1px solid rgba(0, 242, 255, 0.2);
            display: flex; justify-content: space-around; padding: 10px 0;
            z-index: 1000; backdrop-filter: blur(10px);
        }
        @media (min-width: 768px) {
            nav { top: 0; bottom: auto; border-top: none; border-bottom: 1px solid rgba(0, 242, 255, 0.2); }
        }
        nav button {
            background: none; border: none; color: #666; font-family: 'Orbitron';
            font-size: 0.7rem; cursor: pointer; transition: 0.3s; padding: 10px;
        }
        nav button.active { color: var(--acid-green); text-shadow: 0 0 10px var(--acid-green); }

        .app-container { max-width: 1200px; margin: 0 auto; padding: 15px 15px 80px 15px; }
        @media (min-width: 768px) { .app-container { padding-top: 80px; } }

        /* --- HUD CARDS & HELP --- */
        .hud-card {
            background: var(--panel-bg); border-left: 4px solid var(--cyber-blue);
            padding: 20px; margin-bottom: 15px; border-radius: 0 10px 10px 0;
            position: relative;
        }
        .hud-header {
            font-family: 'Orbitron'; font-size: 0.8rem; color: var(--cyber-blue);
            margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;
        }
        
        .help-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 24px; height: 24px; border: 1px solid var(--cyber-blue);
            border-radius: 50%; color: var(--cyber-blue); cursor: pointer;
            font-size: 14px; font-weight: bold; margin-left: 10px;
        }
        .help-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); border: 1px solid var(--acid-green);
            padding: 20px; width: 80%; max-width: 400px; z-index: 10001;
            color: #fff; border-radius: 8px; display: none;
        }
        .help-modal h3 { color: var(--acid-green); margin-top: 0; font-family: 'Orbitron'; }
        .help-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: none;
        }

        /* --- CAMERA --- */
        .cam-wrapper { width: 100%; background: #000; border-radius: 8px; overflow: hidden; position: relative; }
        #cam-feed { width: 100%; display: block; transform: rotate(180deg); transition: 0.3s; cursor: zoom-in; }
        
        .cam-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.95); z-index: 11000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .cam-overlay.active { opacity: 1; pointer-events: all; }
        .cam-overlay img {
            max-width: 100%; max-height: 100%; transform: rotate(180deg);
            object-fit: contain;
        }
        .close-cam {
            position: absolute; top: 20px; right: 20px;
            background: var(--danger-red); color: white; border: none;
            padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 5px;
        }

        /* --- SENSOR GRID --- */
        .sensor-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        @media (min-width: 768px) { .sensor-grid { grid-template-columns: repeat(3, 1fr); } }
        
        .sensor-module { 
            background: rgba(255,255,255,0.03); padding: 15px; text-align: center; 
            border: 1px solid rgba(255,255,255,0.05); transition: 0.3s;
        }
        .sensor-module:hover { border-color: var(--cyber-blue); }
        .sensor-module .val { font-size: 2.2rem; font-weight: 700; color: #fff; line-height: 1; }
        .sensor-module label { font-size: 0.7rem; color: var(--cyber-blue); text-transform: uppercase; display: block; margin-bottom: 5px; }
        .sensor-module.npk-box { border-left: 2px solid var(--acid-green); }

        .btn-master {
            width: 100%; padding: 15px; font-family: 'Orbitron'; font-weight: bold;
            border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;
            text-transform: uppercase;
        }
        .btn-master.on { background: var(--acid-green); color: #000; box-shadow: 0 0 15px rgba(191, 255, 0, 0.3); }
        .btn-master.off { background: #222; color: #fff; }
        
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #222; }
        .btn-toggle { padding: 8px 15px; border-radius: 20px; border: 1px solid #444; background: none; color: #fff; font-weight: bold; cursor: pointer; }
        .btn-toggle.active { background: var(--cyber-blue); color: #000; border-color: var(--cyber-blue); }

        .hidden { display: none !important; }
        .disabled { opacity: 0.2; pointer-events: none; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { color: var(--cyber-blue); text-align: left; padding: 12px; border-bottom: 2px solid #222; }
        td { padding: 12px; border-bottom: 1px solid #111; }
    </style>
</head>
<body>

    <audio id="bgm-player" loop></audio>

    <div id="auth-screen">
        <div class="terminal-card">
            <h1>BIOCUBE</h1>
            <input type="text" id="username" placeholder="OPERATOR_ID">
            <input type="password" id="password" placeholder="ACCESS_CODE">
            <div style="margin-top: 15px;">
                <button class="btn-master on" onclick="handleAuth('login')">INITIALIZE</button>
                <button class="btn-master off" style="font-size: 0.7rem; margin-top: 8px;" onclick="handleAuth('register')">NEW REGISTRATION</button>
            </div>
            <p id="auth-msg" style="color:var(--danger-red); margin-top:15px; font-size:0.8rem;"></p>
        </div>
    </div>

    <div id="cam-overlay" class="cam-overlay">
        <button class="close-cam" onclick="closeFullCam()">CLOSE VIEW [X]</button>
        <img id="cam-feed-full" src="" alt="STREAM">
    </div>

    <div id="help-overlay" class="help-overlay" onclick="closeHelp()"></div>
    <div id="help-modal" class="help-modal">
        <h3 id="help-title">SYSTEM HELP</h3>
        <p id="help-text" style="line-height: 1.6; font-size: 0.9rem;"></p>
        <button class="btn-master off" style="margin-top:15px; padding:10px;" onclick="closeHelp()">ACKNOWLEDGE</button>
    </div>

    <div id="app-screen" class="hidden">
        <nav>
            <button class="active" onclick="nav('home', this)">STATUS</button>
            <button onclick="nav('manual', this)">OVERRIDE</button>
            <button onclick="nav('settings', this)">LOGIC</button>
            <button id="btn-admin-nav" class="hidden" onclick="nav('admin', this)">ADMIN</button>
            <button onclick="logout()" style="color:var(--danger-red)">EXIT</button>
        </nav>

        <div class="app-container">
            
            <div id="page-home">
                <div class="hud-card">
                    <div class="hud-header">
                        <span>LIVE_FEED_01</span>
                        <div style="display:flex; align-items:center;">
                            <span id="pi-status-tag" style="color:var(--danger-red); margin-right:10px;">● LINK_DOWN</span>
                            <span class="help-icon" onclick="showHelp('home')">?</span>
                        </div>
                    </div>
                    <div class="cam-wrapper">
                        <img id="cam-feed" src="" alt="SIGNAL LOST" ondblclick="openFullCam()">
                    </div>
                    <p style="text-align:center; font-size:0.7rem; color:#666; margin-top:5px;">DOUBLE TAP VIDEO TO EXPAND</p>
                </div>

                <div class="sensor-grid">
                    <div class="sensor-module"><label>Temp</label><div class="val" id="v-temp">--</div><span>°C</span></div>
                    <div class="sensor-module"><label>Humid</label><div class="val" id="v-hum">--</div><span>%</span></div>
                    <div class="sensor-module"><label>Soil</label><div class="val" id="v-soil">--</div><span>%</span></div>
                    <div class="sensor-module npk-box"><label>Nitrogen (N)</label><div class="val" id="v-n">--</div><span>mg/kg</span></div>
                    <div class="sensor-module npk-box"><label>Phosphorus (P)</label><div class="val" id="v-p">--</div><span>mg/kg</span></div>
                    <div class="sensor-module npk-box"><label>Potassium (K)</label><div class="val" id="v-k">--</div><span>mg/kg</span></div>
                </div>

                <div class="hud-card" style="margin-top:20px;">
                    <div class="hud-header">DATA_EXPORT_CENTER</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn-master off" style="font-size: 0.7rem;" onclick="window.open('/api/download/standard')">MASTER CSV (EXCEL)</button>
                        <button class="btn-master off" style="font-size: 0.7rem;" onclick="window.open('/api/download/academic')">DETAILED CSV (PRO)</button>
                    </div>
                    <canvas id="sensorChart" style="max-height: 200px; margin-top:20px;"></canvas>
                </div>
            </div>

            <div id="page-manual" class="hidden">
                <div class="hud-card">
                    <div class="hud-header">
                        HARDWARE_OVERRIDE
                        <span class="help-icon" onclick="showHelp('manual')">?</span>
                    </div>
                    <p id="manual-lock-msg" style="color:var(--warning-orange); font-size:0.8rem;">⚠️ AUTO-MODE ACTIVE: COMMANDS REJECTED</p>
                    <div id="manual-controls" class="disabled">
                        <div class="toggle-row"><span>Water Pump</span><button class="btn-toggle" onclick="toggleActuator('water', this)">OFF</button></div>
                        <div class="toggle-row"><span>Nutrient Pump</span><button class="btn-toggle" onclick="toggleActuator('nutrient', this)">OFF</button></div>
                        <div class="toggle-row"><span>Exhaust Fan</span><button class="btn-toggle" onclick="toggleActuator('exhaust', this)">OFF</button></div>
                        <div class="toggle-row"><span>Peltier Cooling</span><button class="btn-toggle" onclick="toggleActuator('cool', this)">OFF</button></div>
                    </div>
                </div>
            </div>

            <div id="page-settings" class="hidden">
                <div class="hud-card">
                    <div class="hud-header">
                        AUDIO_SUBSYSTEM
                        <span class="help-icon" onclick="showHelp('audio')">?</span>
                    </div>
                    <div class="toggle-row">
                        <span>BGM_STATUS</span>
                        <button id="btn-audio-toggle" class="btn-toggle" onclick="toggleAudio()">OFF</button>
                    </div>
                    <div class="toggle-row" style="flex-direction: column; align-items: flex-start;">
                        <span style="margin-bottom:5px;">GAIN_LEVEL (VOL)</span>
                        <input type="range" id="vol-slider" min="0" max="1" step="0.05" value="0.5" oninput="setVolume(this.value)">
                    </div>
                    <div class="toggle-row" style="flex-direction: column; align-items: flex-start; border-bottom: none;">
                        <span style="margin-bottom:5px;">TRACK_SELECTOR (PvZ_OST_FULL)</span>
                        <select id="track-select" onchange="changeTrack(this.value)">
                            <option value="t01">01_CRAZY_DAVES_GREETING</option>
                            <option value="t02">02_INTRO_THEME</option>
                            <option value="t03">03_CHOOSE_YOUR_SEEDS</option>
                            <option value="t04">04_GRASSWALK</option>
                            <option value="t05">05_LOONBOON</option>
                            <option value="t06">06_MOONGRAINS</option>
                            <option value="t07">07_ZEN_GARDEN</option>
                            <option value="t08">08_WATERY_GRAVES_SLOW</option>
                            <option value="t09">09_WATERY_GRAVES_FAST</option>
                            <option value="t10">10_ULTIMATE_BATTLE</option>
                            <option value="t11">11_RIGOR_MORMIST</option>
                            <option value="t12">12_CEREBRAWL</option>
                            <option value="t13">13_GRAZE_THE_ROOF</option>
                            <option value="t14">14_BRAINIAC_MANIAC</option>
                            <option value="t15">15_ZOMBIES_ON_YOUR_LAWN</option>
                            <option value="t16">16_ZOMBOTANY_UNRELEASED</option>
                            <option value="t17">17_URANIWA_NI_ZOMBIES</option>
                            <option value="t18">18_CRAZY_DAVE_INGAME</option>
                            <option value="t19">19_CHOOSE_SEEDS_INGAME</option>
                            <option value="t20">20_GRASSWALK_INGAME</option>
                            <option value="t21">21_LOONBOON_INGAME</option>
                            <option value="t22">22_MOONGRAINS_INGAME</option>
                            <option value="t23">23_ZEN_GARDEN_INGAME</option>
                            <option value="t24">24_WATERY_GRAVES_INGAME</option>
                            <option value="t25">25_ULTIMATE_BATTLE_INGAME</option>
                            <option value="t26">26_RIGOR_MORMIST_INGAME</option>
                            <option value="t27">27_CEREBRAWL_INGAME</option>
                            <option value="t28">28_GRAZE_THE_ROOF_INGAME</option>
                            <option value="t29">29_BRAINIAC_MANIAC_INGAME</option>
                        </select>
                    </div>
                </div>

                <div class="hud-card">
                    <div class="hud-header">
                        SYSTEM_LOGIC_CONFIGURATION
                        <span class="help-icon" onclick="showHelp('settings')">?</span>
                    </div>
                    <div class="toggle-row" style="margin-bottom:20px;">
                        <span>AUTOMATION ENGINE</span>
                        <button id="btn-auto-toggle" class="btn-toggle" onclick="toggleAuto()">OFF</button>
                    </div>
                    
                    <div class="toggle-row"><span>Cooling Trigger (Temp > X)</span><input type="number" id="th-temp" value="28" style="width:60px; background:#000; border:1px solid #444; color:cyan; padding:5px;"></div>
                    <div class="toggle-row"><span>Exhaust Trigger (Humid > X)</span><input type="number" id="th-hum" value="70" style="width:60px; background:#000; border:1px solid #444; color:cyan; padding:5px;"></div>
                    <div class="toggle-row"><span>Watering Trigger (Soil < X)</span><input type="number" id="th-soil" value="30" style="width:60px; background:#000; border:1px solid #444; color:cyan; padding:5px;"></div>
                    
                    <h3 style="color:var(--acid-green); font-size:0.8rem; margin-top:20px;">NUTRIENT THRESHOLDS (NPK mg/kg)</h3>
                    <div class="toggle-row"><span>N-Min Target</span><input type="number" id="th-n" value="50" style="width:60px; background:#000; border:1px solid #444; color:cyan; padding:5px;"></div>
                    <div class="toggle-row"><span>P-Min Target</span><input type="number" id="th-p" value="30" style="width:60px; background:#000; border:1px solid #444; color:cyan; padding:5px;"></div>
                    <div class="toggle-row"><span>K-Min Target</span><input type="number" id="th-k" value="40" style="width:60px; background:#000; border:1px solid #444; color:cyan; padding:5px;"></div>

                    <button class="btn-master on" onclick="updateThresholds()">SYNC ALL THRESHOLDS</button>
                </div>
            </div>

            <div id="page-admin" class="hidden">
                <div class="hud-card">
                    <div class="hud-header">
                        OPERATOR_MANAGEMENT
                        <span class="help-icon" onclick="showHelp('admin')">?</span>
                    </div>
                    <div class="admin-table-container">
                        <table>
                            <thead><tr><th>USER</th><th>ROLE</th><th>STATUS</th><th>ACTIONS</th></tr></thead>
                            <tbody id="admin-user-list"></tbody>
                        </table>
                    </div>

                    <!-- Fake sensor data control (admin only) -->
                    <div style="margin-top:15px; border-top:1px solid #222; padding-top:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-size:0.8rem; color:var(--cyber-blue); font-family:Orbitron;">SENSOR MODE</div>
                                <div style="font-size:0.9rem;">Enable simulated sensor output</div>
                            </div>
                            <div>
                                <button id="btn-fake-toggle" class="btn-toggle" onclick="toggleFake()">OFF</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script>
        const socket = io();
        let isAuto = true;
        let myRole = 'operator';

        // --- FAKE SENSOR MODE STATE ---
        let useFakeSensors = false;
        let fakeInterval = null;
        let fakeState = {
            temp: 0,
            hum: 0,
            soil: 0,
            n: 0,
            p: 0,
            k: 0
        };

        // smoothing factor to make changes gradual
        const SMOOTH = 0.7; // 0..1 where 1 = no smoothing

        // --- AUDIO SYSTEM LOGIC ---
        const audioPlayer = document.getElementById('bgm-player');
        let isPlaying = false;

        // --- FULL PVZ OST PLAYLIST ---
        // PLEASE RENAME YOUR LOCAL FILES TO MATCH THESE EXACT NAMES:
        const playlist = {
            't01': 'music/01_crazy_daves_greeting.mp3',
            't02': 'music/02_intro_theme.mp3',
            't03': 'music/03_choose_your_seeds.mp3',
            't04': 'music/04_grasswalk.mp3',
            't05': 'music/05_loonboon.mp3',
            't06': 'music/06_moongrains.mp3',
            't07': 'music/07_zen_garden.mp3',
            't08': 'music/08_watery_graves_slow.mp3',
            't09': 'music/09_watery_graves_fast.mp3',
            't10': 'music/10_ultimate_battle.mp3',
            't11': 'music/11_rigor_mormist.mp3',
            't12': 'music/12_cerebrawl.mp3',
            't13': 'music/13_graze_the_roof.mp3',
            't14': 'music/14_brainiac_maniac.mp3',
            't15': 'music/15_zombies_on_your_lawn.mp3',
            't16': 'music/16_zombotany_unreleased.mp3',
            't17': 'music/17_uraniwa_ni_zombies.mp3',
            't18': 'music/18_crazy_dave_ingame.mp3',
            't19': 'music/19_choose_seeds_ingame.mp3',
            't20': 'music/20_grasswalk_ingame.mp3',
            't21': 'music/21_loonboon_ingame.mp3',
            't22': 'music/22_moongrains_ingame.mp3',
            't23': 'music/23_zen_garden_ingame.mp3',
            't24': 'music/24_watery_graves_ingame.mp3',
            't25': 'music/25_ultimate_battle_ingame.mp3',
            't26': 'music/26_rigor_mormist_ingame.mp3',
            't27': 'music/27_cerebrawl_ingame.mp3',
            't28': 'music/28_graze_the_roof_ingame.mp3',
            't29': 'music/29_brainiac_maniac_ingame.mp3'
        };

        // Initialize default track (Track 01)
        audioPlayer.src = playlist['t01'];
        audioPlayer.volume = 0.5;

        function toggleAudio() {
            const btn = document.getElementById('btn-audio-toggle');
            if (isPlaying) {
                audioPlayer.pause();
                btn.innerText = "OFF";
                btn.classList.remove('active');
                isPlaying = false;
            } else {
                const playPromise = audioPlayer.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        btn.innerText = "ON";
                        btn.classList.add('active');
                        isPlaying = true;
                    }).catch(error => {
                        console.log("Audio Error: File not found or blocked.");
                        alert("AUDIO ERROR: CHECK CONSOLE. ENSURE MP3s EXIST.");
                    });
                }
            }
        }

        function setVolume(val) {
            audioPlayer.volume = val;
        }

        function changeTrack(trackKey) {
            const wasPlaying = isPlaying;
            audioPlayer.src = playlist[trackKey];
            if (wasPlaying) {
                audioPlayer.play();
            }
        }

        // --- AUTH LOGIC ---
        async function handleAuth(type) {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(!u || !p) return alert("CREDENTIALS REQUIRED");

            const res = await fetch(`/api/${type}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            const data = await res.json();
            
            if(data.status === 'ok') {
                if(type === 'login') {
                    localStorage.setItem('token', data.token);
                    myRole = data.role;

                    // TRIPLE CHECK: Admin Override
                    if(u.toLowerCase() === 'admin') myRole = 'admin';

                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app-screen').classList.remove('hidden');
                    
                    if(myRole === 'admin') {
                        document.getElementById('btn-admin-nav').classList.remove('hidden');
                    }
                    initChart();
                } else {
                    alert("OPERATOR REGISTERED. PLEASE INITIALIZE.");
                }
            } else {
                document.getElementById('auth-msg').innerText = data.error.toUpperCase();
            }
        }

        // --- NAVIGATION & UI HELPERS ---
        function nav(page, btn) {
            document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            btn.classList.add('active');
            if(page === 'admin') loadAdminData();
        }

        // Help System Logic
        const helpTexts = {
            'home': "STATUS DASHBOARD:<br>Monitors live environment data. Includes real-time camera feed and NPK nutrient tracking. Data Export allows downloading Excel-ready CSV files.",
            'manual': "HARDWARE OVERRIDE:<br>Directly control relays (Pumps, Fans, Coolers). <br>NOTE: You MUST disable Automation in the Logic tab before controls become active.",
            'settings': "SYSTEM LOGIC:<br>Set the trigger points for automation. For example, if Temp > 28°C, the cooling system activates. NPK values determine nutrient dosing.",
            'audio': "AUDIO SUBSYSTEM:<br>Controls background music playback. Ensure all 29 PvZ MP3 files are in the root directory.",
            'admin': "ADMIN PANEL:<br>Manage user access. Promote operators to Admins, ban bad actors, or delete accounts entirely."
        };

        function showHelp(page) {
            document.getElementById('help-title').innerText = page.toUpperCase() + " GUIDE";
            document.getElementById('help-text').innerHTML = helpTexts[page];
            document.getElementById('help-overlay').style.display = 'block';
            document.getElementById('help-modal').style.display = 'block';
        }

        function closeHelp() {
            document.getElementById('help-overlay').style.display = 'none';
            document.getElementById('help-modal').style.display = 'none';
        }

        // Camera Zoom Logic
        function openFullCam() {
            const overlay = document.getElementById('cam-overlay');
            const mainImg = document.getElementById('cam-feed');
            const fullImg = document.getElementById('cam-feed-full');
            fullImg.src = mainImg.src; // Sync source immediately
            overlay.classList.add('active');
        }

        function closeFullCam() {
            document.getElementById('cam-overlay').classList.remove('active');
        }

        // --- SOCKETS & DATA ---
        let lastRealData = null; // keep last server-sent data if needed

        socket.on('update', (data) => {
            // always keep server data as canonical when not simulating
            lastRealData = data;

            // update mode & ui bits that should always reflect server
            isAuto = data.auto_mode;
            const autoBtn = document.getElementById('btn-auto-toggle');
            autoBtn.innerText = isAuto ? "ON" : "OFF";
            autoBtn.className = isAuto ? "btn-toggle active" : "btn-toggle";
            const manualDiv = document.getElementById('manual-controls');
            const lockMsg = document.getElementById('manual-lock-msg');
            if(isAuto) { manualDiv.classList.add('disabled'); lockMsg.classList.remove('hidden'); }
            else { manualDiv.classList.remove('disabled'); lockMsg.classList.add('hidden'); }

            // Update thresholds values in UI so fake mode can use them
            // (do not overwrite user edits if the element is focused)
            ['th-temp','th-hum','th-soil','th-n','th-p','th-k'].forEach(id => {
                const el = document.getElementById(id);
                if(el && document.activeElement !== el) {
                    // maintain existing value unless server provides something meaningful
                    // we'll not stomp on operator inputs
                }
            });

            // If not faking, show server values
            if(!useFakeSensors) {
                document.getElementById('v-temp').innerText = data.temp_in?.toFixed(1) || "--";
                document.getElementById('v-hum').innerText = data.hum_in?.toFixed(1) || "--";
                document.getElementById('v-soil').innerText = data.soil_moisture || "--";
                document.getElementById('v-n').innerText = data.npk_n || "0";
                document.getElementById('v-p').innerText = data.npk_p || "0";
                document.getElementById('v-k').innerText = data.npk_k || "0";
                updateChart(data);
            }
        });

        socket.on('feed', (data) => {
            const src = 'data:image/jpeg;base64,' + data;
            document.getElementById('cam-feed').src = src;
            // If fullscreen is open, update it too
            if(document.getElementById('cam-overlay').classList.contains('active')) {
                document.getElementById('cam-feed-full').src = src;
            }
        });

        socket.on('pi_status', (data) => {
            const tag = document.getElementById('pi-status-tag');
            tag.innerText = data.online ? "● LINK_ACTIVE" : "● LINK_DOWN";
            tag.style.color = data.online ? "var(--acid-green)" : "var(--danger-red)";
        });

        // --- HARDWARE CONTROLS ---
        function toggleAuto() {
            socket.emit('control_cmd', { cmd: 'set_auto', val: !isAuto });
        }

        function toggleActuator(name, btn) {
            const turnOn = btn.innerText === "OFF";
            socket.emit('control_cmd', { cmd: name, val: turnOn });
            btn.innerText = turnOn ? "ON" : "OFF";
            btn.classList.toggle('active');
        }

        function updateThresholds() {
            const vals = {
                temp: parseInt(document.getElementById('th-temp').value),
                humid: parseInt(document.getElementById('th-hum').value),
                soil: parseInt(document.getElementById('th-soil').value),
                n: parseInt(document.getElementById('th-n').value),
                p: parseInt(document.getElementById('th-p').value),
                k: parseInt(document.getElementById('th-k').value)
            };
            socket.emit('control_cmd', { cmd: 'update_thresholds', val: vals });
            alert("BIOCUBE LOGIC UPDATED");

            // If using fake sensors, update base values right away
            if(useFakeSensors) {
                initializeFakeFromThresholds();
            }
        }

        // --- ADMIN FUNCTIONS ---
        async function loadAdminData() {
            const res = await fetch('/api/users');
            const users = await res.json();
            const tbody = document.getElementById('admin-user-list');
            tbody.innerHTML = '';
            users.forEach(u => {
                tbody.innerHTML += `<tr>
                    <td>${u.username}</td>
                    <td>${u.role}</td>
                    <td>${u.isBanned ? 'BANNED' : 'ACTIVE'}</td>
                    <td>
                        <button onclick="adminAction('${u.username}', 'ban')" style="color:red; background:none; border:none; cursor:pointer;">BAN</button>
                        <button onclick="adminAction('${u.username}', 'promote')" style="color:cyan; background:none; border:none; cursor:pointer;">PRO</button>
                        <button onclick="adminAction('${u.username}', 'delete')" style="color:gray; background:none; border:none; cursor:pointer;">DEL</button>
                    </td>
                </tr>`;
            });
        }

        async function adminAction(targetUser, action) {
            if(!confirm(`CONFIRM ${action.toUpperCase()} ON ${targetUser}?`)) return;
            await fetch('/api/admin/action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({targetUser, action})
            });
            loadAdminData();
        }

        // --- CHARTING ENGINE ---
        let sensorChart;
        function initChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Temp', data: [], borderColor: '#00f2ff', tension: 0.4, pointRadius: 0 },
                        { label: 'Soil', data: [], borderColor: '#bfff00', tension: 0.4, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { grid: { color: '#111' } }, x: { display: false } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateChart(data) {
            if(!sensorChart) return;
            const time = new Date().toLocaleTimeString();
            if(sensorChart.data.labels.length > 20) {
                sensorChart.data.labels.shift();
                sensorChart.data.datasets[0].data.shift();
                sensorChart.data.datasets[1].data.shift();
            }
            sensorChart.data.labels.push(time);
            sensorChart.data.datasets[0].data.push(Number((data.temp_in||0).toFixed(2)));
            sensorChart.data.datasets[1].data.push(Number((data.soil_moisture||0).toFixed(2)));
            sensorChart.update();
        }

        function logout() { localStorage.removeItem('token'); location.reload(); }

        // --- FAKE SENSOR GENERATION ---
        function toggleFake() {
            useFakeSensors = !useFakeSensors;
            const btn = document.getElementById('btn-fake-toggle');
            btn.innerText = useFakeSensors ? 'ON' : 'OFF';
            btn.classList.toggle('active', useFakeSensors);

            if(useFakeSensors) startFakeData();
            else stopFakeData();
        }

        function initializeFakeFromThresholds() {
            // Use thresholds as base values so fake data respects configured targets
            const t = parseFloat(document.getElementById('th-temp').value) || (lastRealData?.temp_in || 25);
            const h = parseFloat(document.getElementById('th-hum').value) || (lastRealData?.hum_in || 60);
            const s = parseFloat(document.getElementById('th-soil').value) || (lastRealData?.soil_moisture || 40);
            const n = parseFloat(document.getElementById('th-n').value) || (lastRealData?.npk_n || 50);
            const p = parseFloat(document.getElementById('th-p').value) || (lastRealData?.npk_p || 30);
            const k = parseFloat(document.getElementById('th-k').value) || (lastRealData?.npk_k || 40);

            // initialize fake state near thresholds but not exactly identical to avoid robotic output
            fakeState.temp = t + (Math.random() * 1.2 - 0.6);
            fakeState.hum = h + (Math.random() * 2.5 - 1.25);
            fakeState.soil = s + (Math.random() * 3 - 1.5);
            fakeState.n = Math.max(0, Math.round(n + (Math.random() * 4 - 2)));
            fakeState.p = Math.max(0, Math.round(p + (Math.random() * 3 - 1.5)));
            fakeState.k = Math.max(0, Math.round(k + (Math.random() * 3 - 1.5)));
        }

        function startFakeData() {
            // if server data exists, seed from that; otherwise seed from thresholds
            initializeFakeFromThresholds();

            if(fakeInterval) clearInterval(fakeInterval);
            fakeInterval = setInterval(() => {
                // gentle random walk towards threshold base
                const tBase = parseFloat(document.getElementById('th-temp').value) || (lastRealData?.temp_in || 25);
                const hBase = parseFloat(document.getElementById('th-hum').value) || (lastRealData?.hum_in || 60);
                const sBase = parseFloat(document.getElementById('th-soil').value) || (lastRealData?.soil_moisture || 40);
                const nBase = parseFloat(document.getElementById('th-n').value) || (lastRealData?.npk_n || 50);
                const pBase = parseFloat(document.getElementById('th-p').value) || (lastRealData?.npk_p || 30);
                const kBase = parseFloat(document.getElementById('th-k').value) || (lastRealData?.npk_k || 40);

                // temperature: aim near threshold but fluctuate slightly
                const tNoise = (Math.random() * 0.8 - 0.4);
                fakeState.temp = (SMOOTH * fakeState.temp) + ((1 - SMOOTH) * (tBase + tNoise));

                // humidity
                const hNoise = (Math.random() * 2 - 1);
                fakeState.hum = (SMOOTH * fakeState.hum) + ((1 - SMOOTH) * (hBase + hNoise));

                // soil moisture: slower changes
                const sNoise = (Math.random() * 2 - 1);
                fakeState.soil = (SMOOTH * fakeState.soil) + ((1 - SMOOTH) * (sBase + sNoise));

                // NPK: integer-ish with minor jitter
                fakeState.n = Math.round((SMOOTH * fakeState.n) + ((1 - SMOOTH) * (nBase + Math.random() * 2 - 1)));
                fakeState.p = Math.round((SMOOTH * fakeState.p) + ((1 - SMOOTH) * (pBase + Math.random() * 1.5 - 0.75)));
                fakeState.k = Math.round((SMOOTH * fakeState.k) + ((1 - SMOOTH) * (kBase + Math.random() * 1.5 - 0.75)));

                // clamp
                fakeState.temp = Number(fakeState.temp.toFixed(1));
                fakeState.hum = Number(Math.max(0, Math.min(100, fakeState.hum)).toFixed(1));
                fakeState.soil = Number(Math.max(0, Math.min(100, fakeState.soil)).toFixed(1));
                fakeState.n = Math.max(0, fakeState.n);
                fakeState.p = Math.max(0, fakeState.p);
                fakeState.k = Math.max(0, fakeState.k);

                // push to UI
                document.getElementById('v-temp').innerText = fakeState.temp.toFixed(1);
                document.getElementById('v-hum').innerText = fakeState.hum.toFixed(1);
                document.getElementById('v-soil').innerText = fakeState.soil.toFixed(1);
                document.getElementById('v-n').innerText = fakeState.n;
                document.getElementById('v-p').innerText = fakeState.p;
                document.getElementById('v-k').innerText = fakeState.k;

                // update chart with a data-like object so existing chart code works
                updateChart({ temp_in: fakeState.temp, soil_moisture: fakeState.soil });
            }, 1500); // every 1.5s
        }

        function stopFakeData() {
            if(fakeInterval) {
                clearInterval(fakeInterval);
                fakeInterval = null;
            }

            // when turning fake off, immediately show last real data if available
            if(lastRealData) {
                document.getElementById('v-temp').innerText = lastRealData.temp_in?.toFixed(1) || "--";
                document.getElementById('v-hum').innerText = lastRealData.hum_in?.toFixed(1) || "--";
                document.getElementById('v-soil').innerText = lastRealData.soil_moisture || "--";
                document.getElementById('v-n').innerText = lastRealData.npk_n || "0";
                document.getElementById('v-p').innerText = lastRealData.npk_p || "0";
                document.getElementById('v-k').innerText = lastRealData.npk_k || "0";
                updateChart(lastRealData);
            }
        }

        // --- INITIALIZATION: keep code integrity ---
        // no changes to socket event names or server API expectations

    </script>
</body>
</html>
