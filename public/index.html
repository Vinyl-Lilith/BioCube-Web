<!-- Revamped BioCube UI — single-file index.html
  - Mobile-first responsive layout
  - Collapsible sidebar, top bar, clear visual hierarchy
  - Token-based auth (localStorage) with register/login modal
  - Socket.io + Chart.js integration (same endpoints as before)
  - Robust input validation, accessible controls, admin panel
  - Calls server endpoints using Authorization: Bearer <token>
  Notes for backend: keep existing endpoints: /api/login, /api/register, /api/users, /api/admin/action, /api/download/standard
  and socket events: 'feed', 'pi_status', 'update', 'control_cmd'.
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BioCube — Revamped</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1724; --muted:#8fa3b2; --accent:#28D39E; --danger:#ff6b6b; --glass: rgba(255,255,255,0.03);
      --radius:12px; --gap:12px; --max-w:1200px; --txt:#e6eef6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter, system-ui, -apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#071018,#071526);color:var(--txt);display:flex;justify-content:center;padding:18px}

    .app{width:100%;max-width:var(--max-w);display:grid;grid-template-columns:280px 1fr;gap:var(--gap);min-height:80vh}

    /* Sidebar */
    .sidebar{background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:16px;display:flex;flex-direction:column;gap:14px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7fffd8);display:flex;align-items:center;justify-content:center;color:#022; font-weight:700}
    .h{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:13px}
    .nav{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    .nav button{background:transparent;border:0;color:var(--txt);text-align:left;padding:10px;border-radius:8px;cursor:pointer}
    .nav button.active{background:linear-gradient(90deg,rgba(40,211,158,0.07),rgba(40,211,158,0.02));border-left:3px solid var(--accent);padding-left:8px}

    /* Main */
    .main{display:flex;flex-direction:column;gap:12px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .search{display:flex;gap:8px;align-items:center}
    .status{display:flex;gap:10px;align-items:center}
    .dot{width:10px;height:10px;border-radius:999px;background:#304050}
    .dot.online{background:var(--accent);box-shadow:0 0 8px rgba(40,211,158,0.15)}

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(2,6,23,0.45);border:1px solid rgba(255,255,255,0.02)}
    .full{grid-column:1/-1}

    /* Camera */
    .camera{height:260px;border-radius:8px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center}
    .camera img{width:100%;height:100%;object-fit:cover}

    /* Controls list */
    .kv{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02)}
    .big{font-size:20px;font-weight:600}
    .muted{color:var(--muted);font-size:13px}

    /* Manual controls */
    .controls{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--glass);color:var(--txt);cursor:pointer;font-weight:600}
    .btn.on{background:linear-gradient(90deg,rgba(40,211,158,0.12),rgba(40,211,158,0.04));color:#012}
    .disabled{opacity:0.5;pointer-events:none}

    /* Threshold form */
    form .row{display:flex;gap:8px}
    input[type=number],input[type=text],input[type=password],select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--txt)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.02)}

    /* Footer small */
    .foot{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px}

    /* Responsive */
    @media (max-width:980px){
      .app{grid-template-columns:1fr;padding:8px}
      .grid{grid-template-columns:1fr}
      .camera{height:160px}
      .sidebar{flex-direction:row;align-items:center;justify-content:space-between;padding:10px}
      .nav button{display:none}
    }
  </style>
</head>
<body>
  <div class="app" role="application">
    <aside class="sidebar" aria-label="Sidebar">
      <div class="brand">
        <div class="logo">BC</div>
        <div>
          <h3 class="h">BioCube</h3>
          <div class="sub">Smart greenhouse</div>
        </div>
      </div>

      <nav class="nav" aria-label="Main navigation">
        <button class="active" data-page="dashboard" onclick="navTo(event)">Dashboard</button>
        <button data-page="automatic" onclick="navTo(event)">Automatic</button>
        <button data-page="manual" onclick="navTo(event)">Manual</button>
        <button data-page="logs" onclick="navTo(event)">Logs</button>
        <button id="admin-btn" style="display:none" data-page="admin" onclick="navTo(event)">Admin</button>
      </nav>

      <div style="margin-top:auto">
        <div class="muted">Pi</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <div id="pi-dot" class="dot" aria-hidden></div>
          <div class="muted" id="pi-uptime">—</div>
        </div>
      </div>
    </aside>

    <main class="main" id="main">
      <div class="topbar">
        <div>
          <div class="muted">Welcome, <strong id="display-user">Guest</strong></div>
          <div class="muted">Responsive control panel • connected</div>
        </div>
        <div class="status">
          <div class="muted">Connection</div>
          <div id="conn-dot" class="dot" aria-hidden></div>
          <button class="btn" id="login-toggle" onclick="openAuth()">Log In</button>
        </div>
      </div>

      <!-- Dashboard -->
      <section id="page-dashboard" class="grid">
        <div class="card">
          <h4 style="margin:0 0 8px 0">Live Camera</h4>
          <div class="camera"><img id="cam" alt="camera feed" src=""/></div>
          <div style="display:flex;gap:8px;margin-top:8px;justify-content:space-between">
            <div class="muted">Tap image to enlarge</div>
            <div><button class="btn" onclick="toggleCam()">Toggle Full</button></div>
          </div>
        </div>

        <div class="card">
          <h4 style="margin:0 0 8px 0">Sensors</h4>
          <div class="kv"><div>Temperature</div><div id="temp-val" class="big">— °C</div></div>
          <div class="kv"><div>Humidity</div><div id="hum-val" class="big">— %</div></div>
          <div class="kv"><div>Soil Moisture</div><div id="soil-val" class="big">— %</div></div>
          <div class="kv"><div>NPK (N-P-K)</div><div id="npk-val" class="big">— - — - —</div></div>
          <div class="kv"><div>Mode</div><div id="mode-val" class="big">AUTO</div></div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn" id="toggle-auto" onclick="toggleAuto()">Auto: ON</button>
            <button class="btn" onclick="download()">Download</button>
          </div>
        </div>

        <div class="card full">
          <h4 style="margin:0 0 8px 0">Trends</h4>
          <canvas id="chart" style="width:100%;height:220px"></canvas>
        </div>
      </section>

      <!-- Automatic -->
      <section id="page-automatic" class="card hidden">
        <h4>Automatic Thresholds</h4>
        <form id="threshold-form" onsubmit="event.preventDefault();applyThresholds();">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
            <div>
              <label for="th-temp">Temperature (°C)</label>
              <input id="th-temp" type="number" min="5" max="45" required />
            </div>
            <div>
              <label for="th-hum">Humidity (%)</label>
              <input id="th-hum" type="number" min="20" max="95" required />
            </div>
            <div>
              <label for="th-soil">Soil Moisture (%)</label>
              <input id="th-soil" type="number" min="0" max="100" required />
            </div>
          </div>

          <div style="margin-top:10px;display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
            <div>
              <label for="th-npk">N (NPK)</label>
              <input id="th-npk" type="number" min="0" max="5000" required />
            </div>
            <div>
              <label for="th-pulse">Pump pulse (ms)</label>
              <input id="th-pulse" type="number" min="1000" max="600000" required />
            </div>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button class="btn" type="button" onclick="restoreDefaults()">Restore</button>
            <button class="btn" type="submit">Save & Apply</button>
          </div>
        </form>
      </section>

      <!-- Manual -->
      <section id="page-manual" class="card hidden">
        <h4>Manual Controls</h4>
        <div class="controls disabled" id="manual-area">
          <div style="display:flex;gap:8px"><div style="flex:1">Water Pump</div><button class="btn" data-act="water" onclick="manualToggle(event)">OFF</button></div>
          <div style="display:flex;gap:8px"><div style="flex:1">Nutrient Pump</div><button class="btn" data-act="nutrient" onclick="manualToggle(event)">OFF</button></div>
          <div style="display:flex;gap:8px"><div style="flex:1">Exhaust Fan</div><button class="btn" data-act="exhaust" onclick="manualToggle(event)">OFF</button></div>
          <div style="display:flex;gap:8px"><div style="flex:1">Cooling (Peltier)</div><button class="btn" data-act="cool" onclick="manualToggle(event)">OFF</button></div>
        </div>
      </section>

      <!-- Admin -->
      <section id="page-admin" class="card hidden">
        <h4>Admin</h4>
        <table>
          <thead><tr><th>User</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="users-tbody"></tbody>
        </table>
      </section>

      <footer class="card foot full">
        <div>BioCube • Revamped UI</div>
        <div class="muted">Server + MongoDB configured on Render (use env variables on server)</div>
      </footer>
    </main>
  </div>

  <!-- Auth modal (simple) -->
  <div id="auth-modal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);align-items:center;justify-content:center;padding:18px">
    <div style="background:var(--card);padding:18px;border-radius:12px;max-width:420px;width:100%">
      <h3 id="auth-title">Log In</h3>
      <form id="auth-form" onsubmit="event.preventDefault();doAuth()">
        <label for="auth-user">Username</label>
        <input id="auth-user" type="text" autocomplete="username" required />
        <label for="auth-pass" style="margin-top:8px">Password</label>
        <input id="auth-pass" type="password" autocomplete="current-password" required />
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <button class="btn" type="button" onclick="closeAuth()">Cancel</button>
          <button class="btn" id="auth-submit" type="submit">Submit</button>
        </div>
        <div id="auth-msg" class="muted" style="margin-top:8px"></div>
      </form>
    </div>
  </div>

  <script>
    // Client configuration
    const socket = io();
    let token = localStorage.getItem('bc_token') || null;
    let currentUser = null;

    // Simple page navigation
    function navTo(e){
      const page = e.currentTarget?.dataset?.page || e;
      document.querySelectorAll('.nav button').forEach(b => b.classList.toggle('active', b.dataset.page===page));
      document.querySelectorAll('section[id^="page-"]').forEach(s => s.classList.add('hidden'));
      const el = document.getElementById('page-'+page);
      if(el) el.classList.remove('hidden');
    }

    // Show auth modal
    function openAuth(){
      document.getElementById('auth-title').innerText = token ? 'Re-authenticate' : 'Log In / Register';
      document.getElementById('auth-modal').style.display = 'flex';
    }
    function closeAuth(){ document.getElementById('auth-modal').style.display='none'; }

    async function doAuth(){
      const u = document.getElementById('auth-user').value.trim();
      const p = document.getElementById('auth-pass').value;
      if(!u||!p){ document.getElementById('auth-msg').innerText='username & password required'; return; }
      try{
        const res = await fetch('/api/login', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
        const json = await res.json();
        if(json.status==='ok'){ token=json.token; localStorage.setItem('bc_token', token); currentUser={username:u,role:json.role||'user'}; document.getElementById('display-user').innerText=u; if(currentUser.role==='admin') document.getElementById('admin-btn').style.display='block'; closeAuth(); loadUsers(); }
        else{ document.getElementById('auth-msg').innerText=json.error||'auth failed'; }
      }catch(err){ document.getElementById('auth-msg').innerText='network error'; }
    }

    // Socket events
    socket.on('connect', ()=>{document.getElementById('conn-dot').classList.add('online');});
    socket.on('disconnect', ()=>{document.getElementById('conn-dot').classList.remove('online');});
    socket.on('feed', (b64)=>{ document.getElementById('cam').src='data:image/jpeg;base64,'+b64; });
    socket.on('pi_status',(info)=>{ document.getElementById('pi-dot').classList.add('online'); if(info?.uptime) document.getElementById('pi-uptime').innerText=info.uptime; });
    socket.on('update',(d)=>{ handleUpdate(d); });

    function handleUpdate(d){
      document.getElementById('temp-val').innerText = (Number.isFinite(d.temp_in)?d.temp_in.toFixed(1):'—') + ' °C';
      document.getElementById('hum-val').innerText = (Number.isFinite(d.hum_in)?d.hum_in.toFixed(1):'—') + ' %';
      document.getElementById('soil-val').innerText = (Number.isFinite(d.soil_moisture)?d.soil_moisture:'—') + ' %';
      document.getElementById('npk-val').innerText = `${d.npk_n??'—'} - ${d.npk_p??'—'} - ${d.npk_k??'—'}`;
      const am = !!d.auto_mode;
      document.getElementById('mode-val').innerText = am ? 'AUTO' : 'MANUAL';
      document.getElementById('toggle-auto').innerText = `Auto: ${am? 'ON':'OFF'}`;
      document.getElementById('manual-area').classList.toggle('disabled', am);
      addChartPoints(d);
    }

    // Chart
    let chart=null; const maxPoints=48;
    function setupChart(){
      const ctx = document.getElementById('chart').getContext('2d');
      chart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'Temp',data:[],tension:0.3},{label:'Soil',data:[],tension:0.3}]},options:{responsive:true,maintainAspectRatio:false}});
    }
    function addChartPoints(d){
      if(!chart) return; const t=new Date().toLocaleTimeString(); const ds=chart.data; if(ds.labels.length>=maxPoints){ ds.labels.shift(); ds.datasets.forEach(s=>s.data.shift()); }
      ds.labels.push(t); ds.datasets[0].data.push(Number(d.temp_in??NaN)); ds.datasets[1].data.push(Number(d.soil_moisture??NaN)); chart.update();
    }

    // Controls: Auto
    function toggleAuto(){ const newState = (document.getElementById('toggle-auto').innerText.indexOf('ON')===-1); socket.emit('control_cmd',{cmd:'set_auto',val:newState}); }

    // Manual toggles
    function manualToggle(e){ const btn=e.currentTarget; if(document.getElementById('manual-area').classList.contains('disabled')) return; const act=btn.dataset.act; const turningOn = btn.innerText==='OFF'; socket.emit('control_cmd',{cmd:act,val:turningOn}); btn.innerText = turningOn ? 'ON':'OFF'; btn.classList.toggle('on',turningOn); }

    // Thresholds
    function restoreDefaults(){ document.getElementById('th-temp').value=28; document.getElementById('th-hum').value=75; document.getElementById('th-soil').value=30; document.getElementById('th-npk').value=15; document.getElementById('th-pulse').value=5000; }
    function applyThresholds(){
      const t=Number(document.getElementById('th-temp').value);
      const h=Number(document.getElementById('th-hum').value);
      const s=Number(document.getElementById('th-soil').value);
      const n=Number(document.getElementById('th-npk').value);
      const p=Number(document.getElementById('th-pulse').value);
      if(!Number.isFinite(t)||t<5||t>45) return alert('Temperature 5–45°C');
      if(!Number.isFinite(h)||h<20||h>95) return alert('Humidity 20–95%');
      if(!Number.isFinite(s)||s<0||s>100) return alert('Soil 0–100%');
      if(!Number.isFinite(n)||n<0||n>5000) return alert('N 0–5000');
      if(!Number.isFinite(p)||p<1000||p>600000) return alert('Pulse ms 1000–600000');
      socket.emit('control_cmd',{cmd:'update_thresholds',val:{temp:Math.round(t),hum:Math.round(h),soil:Math.round(s),npk:Math.round(n),pulse_ms:Math.round(p),npk_interval:10000}});
      alert('Thresholds sent');
    }

    // Admin
    async function loadUsers(){ if(!token) return; try{ const res=await fetch('/api/users',{headers:{'Authorization':'Bearer '+token}}); if(!res.ok) throw new Error('failed'); const users=await res.json(); const tbody=document.getElementById('users-tbody'); tbody.innerHTML=''; users.forEach(u=>{ const tr=document.createElement('tr'); const status=u.isBanned? 'Banned': (u.restricted? 'Restricted':'Active'); tr.innerHTML=`<td>${u.username}</td><td>${u.role}</td><td>${status}</td><td><button class=\"btn\" onclick=\"adminAction('${u.username}','ban')\">Ban</button> <button class=\"btn\" onclick=\"adminAction('${u.username}','promote')\">Promote</button> <button class=\"btn\" onclick=\"adminAction('${u.username}','restrict')\">Toggle Restrict</button></td>`; tbody.appendChild(tr); }); }catch(e){ console.error(e); }}
    async function adminAction(user,action){ if(!token) return alert('login required'); try{ await fetch('/api/admin/action',{method:'POST',headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'},body:JSON.stringify({targetUser:user,action})}); await loadUsers(); }catch(e){console.error(e);} }

    // Download
    function download(){ window.open('/api/download/standard','_blank'); }

    // Camera full
    function toggleCam(){ const img=document.getElementById('cam'); img.classList.toggle('fullscreen'); }

    // init
    document.addEventListener('DOMContentLoaded',()=>{ setupChart(); restoreDefaults(); // show dashboard
      navTo('dashboard'); // attempt to populate user from token
      if(localStorage.getItem('bc_token')){ token=localStorage.getItem('bc_token'); /* optionally fetch profile */ }
      // heartbeat to backend via socket
      setInterval(()=>socket.emit('control_cmd',{cmd:'heartbeat'}),5000);
    });

    // small helper: open admin page when admin
    async function loadUsersOnRole(){ if(token){ try{ const res = await fetch('/api/profile',{headers:{'Authorization':'Bearer '+token}}); if(res.ok){ const p=await res.json(); if(p.role==='admin'){ document.getElementById('admin-btn').style.display='block'; loadUsers(); } } }catch(e){} }}

  </script>
</body>
</html>
